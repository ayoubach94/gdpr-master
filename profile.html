<html>
  <head>
    <title>Demo Firebase</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/tool.css" rel="stylesheet" />
    <link href="css/loader.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand text-white" id="label-user"></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <div class="btn-group">
              <button
                type="button"
                class="btn btn-secondary dropdown-toggle"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="currentColor"
                  class="bi bi-person-gear"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm.256 7a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Zm3.63-4.54c.18-.613 1.048-.613 1.229 0l.043.148a.64.64 0 0 0 .921.382l.136-.074c.561-.306 1.175.308.87.869l-.075.136a.64.64 0 0 0 .382.92l.149.045c.612.18.612 1.048 0 1.229l-.15.043a.64.64 0 0 0-.38.921l.074.136c.305.561-.309 1.175-.87.87l-.136-.075a.64.64 0 0 0-.92.382l-.045.149c-.18.612-1.048.612-1.229 0l-.043-.15a.64.64 0 0 0-.921-.38l-.136.074c-.561.305-1.175-.309-.87-.87l.075-.136a.64.64 0 0 0-.382-.92l-.148-.045c-.613-.18-.613-1.048 0-1.229l.148-.043a.64.64 0 0 0 .382-.921l-.074-.136c-.306-.561.308-1.175.869-.87l.136.075a.64.64 0 0 0 .92-.382l.045-.148ZM14 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0Z"
                  />
                </svg>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="admin.html">Encuesta</a>
                </li>
                <li>
                  <a class="dropdown-item" href="profile.html">perfil</a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="javascript:void(0)"
                    onclick="closeSession()"
                    >Cerrar sesión</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container-card">
      <div
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
        id="alert"
      >
        <span id="alert-message"> </span>
        <button type="button" class="btn-close" onclick="closeAlert()"></button>
      </div>

      <div
        class="alert alert-success alert-dismissible fade show"
        role="alert"
        id="alert-success"
      >
        <span>Actualizar los datos del usuario correctamente.</span>
        <button
          type="button"
          class="btn-close"
          onclick="closeAlertSuccess()"
        ></button>
      </div>

      <div class="card" style="width: 25rem">
        <div class="card-body">
          <h5 class="card-title">Actualizar datos de perfil</h5>
          <form>
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre</label>
              <input
                type="text"
                class="form-control"
                id="nombre"
                aria-describedby="emailHelp"
              />
            </div>
            <div class="mb-3">
              <label for="apellidos" class="form-label">Apellidos</label>
              <input
                type="text"
                class="form-control"
                id="apellidos"
                aria-describedby="emailHelp"
              />
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Correo</label>
              <input type="text" class="form-control" id="email" disabled />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="password" />
            </div>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updatePassword()"
            >
              Actualizar
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.0/firebase-auth.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>
  <script src="  https://printjs-4de6.kxcdn.com/print.min.js"></script>
  <script src="js/loader.js"></script>
  <script>
    const $labelUser = $("#label-user");
    const storedData = JSON.parse(localStorage.getItem("storedData"));
    console.log(storedData);
    if (!storedData) {
      location.href = "index.html";
    }

    $labelUser.html(
      `<b>Usuario:</b> ${storedData.nombre} ${storedData.apellidos}`,
    );

    /*Configuracion de firebase*/
    const firebaseConfig = {
      apiKey: "AIzaSyB_5M79yHsSird0OtXwwYzIouKWXJtO9ag",
      authDomain: "gdpr-3f8a8.firebaseapp.com",
      projectId: "gdpr-3f8a8",
      storageBucket: "gdpr-3f8a8.appspot.com",
      messagingSenderId: "350297644099",
      appId: "1:350297644099:web:f340fb43acd008ad4d48f6",
      measurementId: "G-58H1J6GH4W",
    };
    firebase.initializeApp(firebaseConfig);

    const $alert = $("#alert");
    const $alertSuccess = $("#alert-success");
    const $loader = $(loader);
    const $nombre = $("#nombre");
    const $apellidos = $("#apellidos");
    const $body = $("body");
    const $email = $("#email");
    const $password = $("#password");
    const $alertMessage = $("#alert-message");

    $nombre.val(storedData.nombre);
    $apellidos.val(storedData.apellidos);
    $email.val(storedData.email);

    $loader.prependTo($body);

    $alert.hide();
    $alertSuccess.hide();
    $loader.hide();

    /*FUncion para cerrar alerta*/
    const closeAlert = () => {
      $alert.hide();
    };

    /*Funcion para cerrar alerta exitosa*/
    const closeAlertSuccess = () => {
      $alertSuccess.hide();
    };

    /*Configuracion para cerrar sesion*/
    const closeSession = () => {
      if (confirm("¿Esta seguro que desea cerrar sesión?")) {
        $loader.show();
        firebase
          .auth()
          .signOut()
          .then(function () {
            localStorage.setItem("user", null);
            location.href = "index.html";
            $loader.hide();
          })
          .catch(function (error) {
            console.error("Error signing out:", error);
            $loader.hide();
          });
      }
    };

    /*Funcion para actualizar contraseña*/
    const updatePassword = () => {
      const email = $email.val();
      const password = $password.val();
      const nombre = $nombre.val();
      const apellidos = $apellidos.val();

      if (nombre === null || nombre === "") {
        $alertMessage.text("El campo nombre no puede estar vacio.");
        $alert.show();
        return false;
      }

      if (apellidos === null || apellidos === "") {
        $alertMessage.text("El campo apellidos no puede estar vacio.");
        $alert.show();
        return false;
      }
      if (password === null || password === "") {
        $alertMessage.text("El campo contraseña no puede estar vacio.");
        $alert.show();
        return false;
      }

      $alert.hide();
      $alertSuccess.hide();
      $loader.show();

      firebase
        .auth()
        .signInWithEmailAndPassword(storedData.email, storedData.password)
        .then((userCredential) => {
          const user = userCredential.user;
          firebase
            .database()
            .ref(`/usuarios/${user.uid}/`)
            .once("value")
            .then(function (snapshot) {
              var currentUser = firebase.auth().currentUser;
              currentUser
                .updatePassword(password)
                .then(function () {
                  firebase
                    .database()
                    .ref("usuarios/" + storedData.uid)
                    .update({
                      nombre,
                      apellidos,
                    })
                    .then(function () {
                      $loader.hide();
                      storedData.password = password;
                      storedData.nombre = nombre;
                      storedData.apellidos = apellidos;
                      localStorage.setItem(
                        "storedData",
                        JSON.stringify(storedData),
                      );
                      $labelUser.html(
                        `<b>Usuario:</b> ${storedData.nombre} ${storedData.apellidos}`,
                      );

                      $alertSuccess.show();
                    })
                    .catch(function (error) {
                      $alert.show();
                      $alertMessage.text(
                        "No se pudo actualizar su usuario, pero si la contraseña.",
                      );
                    });
                })
                .catch(function (error) {
                  $loader.hide();
                  $alertMessage.text("No se pudo cambiar su contraseña.");
                });
            });
        })
        .catch((error) => {
          $loader.hide();
          $alert.show();
          $alertMessage.text("Correo o contraseña incorrecto.");
        });
    };
  </script>
</html>
