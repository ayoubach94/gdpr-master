<html>
  <head>
    <title>Demo Firebase</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/tool.css" rel="stylesheet" />
    <link href="css/loader.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand text-white" id="label-user"></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <div class="btn-group">
              <button
                type="button"
                class="btn btn-secondary dropdown-toggle"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="currentColor"
                  class="bi bi-person-gear"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm.256 7a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Zm3.63-4.54c.18-.613 1.048-.613 1.229 0l.043.148a.64.64 0 0 0 .921.382l.136-.074c.561-.306 1.175.308.87.869l-.075.136a.64.64 0 0 0 .382.92l.149.045c.612.18.612 1.048 0 1.229l-.15.043a.64.64 0 0 0-.38.921l.074.136c.305.561-.309 1.175-.87.87l-.136-.075a.64.64 0 0 0-.92.382l-.045.149c-.18.612-1.048.612-1.229 0l-.043-.15a.64.64 0 0 0-.921-.38l-.136.074c-.561.305-1.175-.309-.87-.87l.075-.136a.64.64 0 0 0-.382-.92l-.148-.045c-.613-.18-.613-1.048 0-1.229l.148-.043a.64.64 0 0 0 .382-.921l-.074-.136c-.306-.561.308-1.175.869-.87l.136.075a.64.64 0 0 0 .92-.382l.045-.148ZM14 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0Z"
                  />
                </svg>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="profile.html">perfil</a>
                </li>
                <li>
                  <a class="dropdown-item" href="admin.html">encuesta</a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="javascript:void(0)"
                    onclick="closeSession()"
                    >Cerrar sesión</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container-card">
      <div class="card" style="width: 30rem">
        <div class="card-body">
          <h5 class="card-title">Registrate pregunta</h5>
          <form>
            <div class="mb-3">
              <label class="form-label">Categoria Amenaza</label>
              <select
                class="form-control"
                id="categoria-amenaza"
                onchange="changeCategoriaAmenaza(event)"
              ></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Tipo Amenaza</label>
              <select
                class="form-control"
                id="tipo-amenaza"
                onchange="changeTipoAmenaza(event)"
              >
                <option value="--seleccionar--">--Seleccionar--</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Objetivo</label>
              <select class="form-control" id="objetivo">
                <option value="--seleccionar--">--Seleccionar--</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Dominio Control</label>
              <input type="text" class="form-control" id="dominio-control" />
            </div>
            <div class="mb-3">
              <label class="form-label">Control</label>
              <input type="text" class="form-control" id="control" />
            </div>
            <div class="mb-3">
              <label class="form-label">Norma</label>
              <input type="text" class="form-control" id="norma" />
            </div>
            <div class="mb-3">
              <label class="form-label">Coste</label>
              <input type="text" class="form-control" id="coste" />
            </div>
            <div class="mb-3">
              <label class="form-label">Personas implicadas</label>
              <input
                type="text"
                class="form-control"
                id="personas-implicadas"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Concepto seguridad</label>
              <input type="text" class="form-control" id="concepto" />
            </div>
            <div class="mb-3">
              <label class="form-label"
                >Propiedades seguridad información</label
              >
              <input type="text" class="form-control" id="propiedades" />
            </div>
            <div class="mb-3">
              <label class="form-label">Capacidades operativas</label>
              <input
                type="text"
                class="form-control"
                id="capacidades-operativas"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Pregunta</label>
              <input type="text" class="form-control" id="pregunta" />
            </div>
            <div class="mb-3">
              <label class="form-label">Recomendación</label>
              <input type="text" class="form-control" id="recomendacion" />
            </div>
            <button type="button" class="btn btn-primary" onclick="register()">
              Registrate
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.0/firebase-auth.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>
  <script src="js/loader.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB_5M79yHsSird0OtXwwYzIouKWXJtO9ag",
      authDomain: "gdpr-3f8a8.firebaseapp.com",
      projectId: "gdpr-3f8a8",
      storageBucket: "gdpr-3f8a8.appspot.com",
      messagingSenderId: "350297644099",
      appId: "1:350297644099:web:f340fb43acd008ad4d48f6",
      measurementId: "G-58H1J6GH4W",
    };
    firebase.initializeApp(firebaseConfig);

    const $labelUser = $("#label-user");
    const storedData = JSON.parse(localStorage.getItem("storedData"));
    console.log(storedData);
    if (!storedData) {
      location.href = "index.html";
    }

    $labelUser.html(
      `<b>Usuario:</b> ${storedData.nombre} ${storedData.apellidos}`,
    );

    const $loader = $(loader);
    const $body = $("body");
    let categoriaAmenazaNombre = "";
    const $categoriaAmenaza = $("#categoria-amenaza");
    let tipoAmenazaNombre = "";
    const $tipoAmenaza = $("#tipo-amenaza");
    let objetivoNombre = "";
    const $objetivo = $("#objetivo");
    const $dominioControl = $("#dominio-control");
    const $control = $("#control");
    const $norma = $("#norma");
    const $coste = $("#coste");
    const $personasImplicadas = $("#personas-implicadas");
    const $concepto = $("#concepto");
    const $propiedades = $("#propiedades");
    const $capacidadesOperativas = $("#capacidades-operativas");
    const $pregunta = $("#pregunta");
    const $recomendacion = $("#recomendacion");

    $loader.prependTo($body);

    $loader.show();
    firebase
      .database()
      .ref("/categoria_amenaza/")
      .once("value")
      .then(function (snapshot) {
        categoriasAmenazas = snapshot.val();
        const arrKeysCA = Object.keys(categoriasAmenazas);
        let html = "<option value=''>--Seleccionar--</option>";
        for (let i = 0; i < arrKeysCA.length; i++) {
          const keyCA = arrKeysCA[i];
          html += `
            <option value='${keyCA}'>${categoriasAmenazas[keyCA].nombre}</option>
          `;
        }
        $categoriaAmenaza.html(html);
        $loader.hide();
      });

    const changeCategoriaAmenaza = (event) => {
      $loader.show();
      $objetivo.html(
        "<option value='--seleccionar--'>--Seleccionar--</option>",
      );
      const categoriaAmenazaId = event.target.value;
      categoriaAmenazaNombre = $categoriaAmenaza.find("option:selected").text();
      firebase
        .database()
        .ref("/tipo_amenaza/")
        .once("value")
        .then(function (snapshot) {
          const tiposAmenazas = snapshot.val();
          const arrKeysTA = Object.keys(tiposAmenazas);
          let html = "<option value=''>--Seleccionar--</option>";
          for (let i = 0; i < arrKeysTA.length; i++) {
            const keyTA = arrKeysTA[i];
            console.log("keyTA", keyTA);
            console.log("categoriaAmenazaId", categoriaAmenazaId);
            if (
              categoriaAmenazaId == tiposAmenazas[keyTA].categoria_amenaza_id
            ) {
              html += `
                        <option value='${keyTA}'>${tiposAmenazas[keyTA].nombre}</option>
                      `;
            }
          }
          $tipoAmenaza.html(html);
          $loader.hide();
        });
    };

    const changeTipoAmenaza = (event) => {
      $loader.show();
      const tipoAmenazaId = event.target.value;
      tipoAmenazaNombre = $tipoAmenaza.find("option:selected").text();
      firebase
        .database()
        .ref("/tipo_control/")
        .once("value")
        .then(function (snapshot) {
          const tiposControl = snapshot.val();
          const arrKeysTC = Object.keys(tiposControl);
          let html = "<option value=''>--Seleccionar--</option>";
          for (let i = 0; i < arrKeysTC.length; i++) {
            const keyTC = arrKeysTC[i];

            if (tipoAmenazaId == tiposControl[keyTC].tipo_amenaza_id) {
              html += `
                        <option value='${keyTC}'>${tiposControl[keyTC].nombre}</option>
                      `;
            }
          }
          $objetivo.html(html);
          $loader.hide();
        });
    };

    const register = () => {
      tipoControlNombre = $objetivo.find("option:selected").text();

      console.log({
        capacidades_operativas: $capacidadesOperativas.val(),
        categoria_amenaza_nombre: categoriaAmenazaNombre,
        concepto: $concepto.val(),
        control: $control.val(),
        coste: $coste.val(),
        dominio_control: $dominioControl.val(),
        norma: $norma.val(),
        personas_implicadas: $personasImplicadas.val(),
        pregunta: $pregunta.val(),
        propiedades: $propiedades.val(),
        recomendacion: $recomendacion.val(),
        tipo_amenaza_nombre: tipoAmenazaNombre,
        tipo_control_id: $objetivo.val(),
        tipo_control_nombre: tipoControlNombre,
      });
      $loader.show();
      firebase
        .database()
        .ref("preguntas/")
        .push({
          capacidades_operativas: $capacidadesOperativas.val(),
          categoria_amenaza_nombre: categoriaAmenazaNombre,
          concepto: $concepto.val(),
          control: $control.val(),
          coste: $coste.val(),
          dominio_control: $dominioControl.val(),
          norma: $norma.val(),
          personas_implicadas: $personasImplicadas.val(),
          pregunta: $pregunta.val(),
          propiedades: $propiedades.val(),
          recomendacion: $recomendacion.val(),
          tipo_amenaza_nombre: tipoAmenazaNombre,
          tipo_control_id: $objetivo.val(),
          tipo_control_nombre: tipoControlNombre,
        })
        .then(function () {
          $loader.hide();
          alert("Se registro correctamente");
        });
    };
  </script>
</html>
